# EL_Bot - Telegram бот для проверки домашних заданий ЕГЭLand

>Version 0.1.0

Telegram-бот для помощи наставникам и администраторам в управлении проверкой домашних заданий. Бот предоставляет информацию о домашних заданиях, ожидающих проверки, и автоматически отправляет уведомления о приближающихся дедлайнах.

## Возможности

- **Информация по домашкам**: Просмотр статистики домашних заданий на проверке по кланам
- **Истекающие домашки**: Список заданий, которые истекают в ближайшие 24 часа
- **Обновление домашек**: Наставники могут обновить данные по домашним заданиям своих кланов прямо из бота
- **Автоматические уведомления**: Напоминания за 24 и 12 часов до дедлайна (72 часа с момента сдачи)
- **Авторизация**: Доступ только для авторизованных наставников и администраторов
- **Фильтрация по кланам**: Каждый наставник видит только домашние задания своих кланов

## Требования

- Python >= 3.14
- Telegram Bot Token (получить у [@BotFather](https://t.me/BotFather))
- Доступ к API ЕГЭLand (для загрузки данных через скрипты)

## Установка

1. **Клонируйте репозиторий:**
   ```bash
   git clone <repository-url>
   cd EL_Bot
   ```

2. **Установите зависимости:**
   
   Проект использует `uv` для управления зависимостями. Установите зависимости:
   ```bash
   uv sync
   ```

3. **Настройте переменные окружения:**
   
   Скопируйте `.env.example` в `.env` и заполните необходимые значения:
   ```bash
   cp .env.example .env
   ```
   
   Отредактируйте `.env` файл:
   ```env
   TELEGRAM_TOKEN=your_telegram_bot_token_here
   API_EMAIL=your_email@example.com
   API_PASSWORD=your_password_here
   ```

4. **Подготовьте данные:**
   
   Убедитесь, что в директории `data/` находятся следующие файлы:
   - `mentors.json` - список наставников
   - `admins.json` - список администраторов
   - `homeworks.json` - список домашних заданий
   
   Для загрузки данных используйте скрипты из директории `scripts/`:
   ```bash
   # Загрузка наставников
   python scripts/mentors.py
   
   # Загрузка домашних заданий
   python scripts/homeworks.py
   
   # Создание администратора (интерактивно)
   python scripts/create_admin.py
   ```

## Использование

### Запуск бота

```bash
uv run main.py
```

Бот автоматически:
- Запустит Telegram бота
- Активирует планировщик уведомлений (проверка каждые 6 минут)
- Начнет обрабатывать команды пользователей

### Команды бота

- `/start` - Начало работы с ботом (проверка авторизации)
- **Информация по домашкам** - Статистика домашних заданий на проверке
- **Истекающие домашки** - Список заданий, истекающих в ближайшие 24 часа
- **Обновить мои домашки** - Обновление данных по домашним заданиям из кланов наставника (доступно только наставникам с кланами)

### Скрипты

#### `scripts/mentors.py`
Загружает список всех наставников из API и сохраняет в `data/mentors.json`. Автоматически фильтрует наставников без Telegram тега или кланов.

#### `scripts/homeworks.py`
Загружает все домашние задания со статусом "Ожидает проверки" из всех кланов наставников и сохраняет в `data/homeworks.json`.

#### `scripts/create_admin.py`
Интерактивный скрипт для создания администратора. Запрашивает данные и добавляет их в `data/admins.json`.

## Структура проекта

```
EL_Bot/
├── main.py                 # Точка входа, запуск бота и планировщика
├── pyproject.toml          # Конфигурация проекта и зависимости
├── .env.example            # Пример файла с переменными окружения
├── README.md               # Документация проекта
├── data/                   # Данные (JSON файлы)
│   ├── mentors.json        # Список наставников
│   ├── admins.json         # Список администраторов
│   └── homeworks.json      # Список домашних заданий
├── scripts/                # Скрипты для загрузки данных
│   ├── mentors.py          # Загрузка наставников
│   ├── homeworks.py        # Загрузка домашних заданий
│   └── create_admin.py     # Создание администратора
└── src/                    # Исходный код бота
    ├── bot.py              # Инициализация бота и диспетчера
    ├── config/             # Конфигурация
    │   └── settings.py     # Настройки и переменные окружения
    ├── core/               # Основные типы и модели
    │   ├── models.py       # Модели данных
    │   └── types.py        # Типы данных
    ├── handlers/           # Обработчики команд
    │   ├── start.py        # Команда /start
    │   ├── info.py         # Информация по домашкам
    │   ├── expiring.py     # Истекающие домашки
    │   ├── update_homeworks.py # Обновление домашек наставника
    │   └── base.py         # Базовые функции авторизации
    ├── keyboards/           # Клавиатуры
    │   └── main_menu.py    # Главное меню
    ├── services/            # Бизнес-логика
    │   ├── auth_service.py        # Авторизация пользователей
    │   ├── homework_service.py    # Работа с домашними заданиями
    │   ├── homework_updater.py    # Обновление домашек через API
    │   ├── notification_service.py # Уведомления
    │   └── data_loader.py          # Загрузка данных из JSON
    └── utils/               # Утилиты
        ├── datetime.py      # Работа с датами и временем
        └── telegram.py      # Утилиты для Telegram
```

## Обновление домашних заданий

Наставники с привязанными кланами могут обновить данные по домашним заданиям прямо из бота, не прибегая к ручному запуску скриптов.

### Как это работает:

1. При нажатии кнопки **"Обновить мои домашки"** бот:
   - Определяет, какие кланы привязаны к наставнику
   - Загружает актуальные данные о домашних заданиях через API для этих кланов
   - Обновляет файл `data/homeworks.json`, сохраняя данные других кланов
   - Очищает кэш и показывает статистику обновления

2. **Блокировка одновременных обновлений**: Если наставник уже запустил обновление, повторный запрос будет отклонен до завершения текущего.

3. **Фильтрация по кланам**: Обновляются только домашние задания кланов, привязанных к конкретному наставнику.

### Доступность функции:

- Доступна наставникам с привязанными кланами
- Недоступна администраторам без кланов

## Авторизация

Бот проверяет авторизацию пользователей по их Telegram username. Пользователь должен быть указан в файлах:
- `data/mentors.json` (наставники)
- `data/admins.json` (администраторы)

**Важно:** Username должен быть указан в поле `telegram_tag` (с символом `@` или без него).

Наставники видят только домашние задания своих кланов (указанных в `clans_mentor`). Администраторы без кланов видят все домашние задания со статусом "Ожидает проверки".

## Логика уведомлений

Бот автоматически отправляет уведомления наставникам о домашних заданиях, которые истекают:
- За 24 часа до дедлайна (окно: 23.7-24.3 часа)
- За 12 часов до дедлайна (окно: 11.7-12.3 часа)

Дедлайн рассчитывается как 72 часа с момента сдачи домашнего задания (`delivery_date`).

Планировщик проверяет задания каждые 6 минут.

## Классификация домашних заданий

Домашние задания классифицируются по времени:
- **overdue** - просрочено (>72 часов с момента сдачи)
- **expiring_soon** - истекает в ближайшие 24 часа
- **in_time** - в срок (осталось больше 24 часов)

## Безопасность

- Все чувствительные данные (токены, пароли) хранятся в файле `.env`, который не должен попадать в репозиторий
- Файл `.env` уже добавлен в `.gitignore`
- Данные пользователей хранятся локально в JSON файлах

## Формат данных

### mentors.json
```json
{
  "export_date": "2026-01-11T02:14:25.211125",
  "total_unique_mentors": 1194,
  "mentors": [
    {
      "id": 15177,
      "first_name": "Имя",
      "last_name": "Фамилия",
      "full_name": "Имя Фамилия",
      "telegram_id": "1819493955",
      "telegram_tag": "username",
      "clans_mentor": [
        {
          "id": 15,
          "name": "Название клана",
          "class": 11
        }
      ]
    }
  ]
}
```

### admins.json
```json
{
  "export_date": "2026-01-11T02:31:30.220858",
  "total_unique_admins": 2,
  "admins": [
    {
      "id": 1768073428746,
      "first_name": "Имя",
      "last_name": "Фамилия",
      "telegram_tag": "username",
      "clans_mentor": []
    }
  ]
}
```

### homeworks.json
```json
{
  "exported_at": "2026-01-11T03:43:03.222038",
  "total_pending": 13243,
  "homeworks": [
    {
      "id": 2484180,
      "delivery_date": "2025-09-21T22:02:06.000000Z",
      "status": "Ожидает проверки",
      "clan_id": 2793,
      "user": {
        "first_name": "Имя",
        "last_name": "Фамилия"
      },
      "homework": {
        "type": {
          "name": "Название задания"
        }
      }
    }
  ]
}
```

## Решение проблем

### Бот не отвечает
- Проверьте, что `TELEGRAM_TOKEN` указан правильно в `.env`
- Убедитесь, что бот запущен и нет ошибок в логах

### "Доступ запрещён"
- Проверьте, что ваш Telegram username указан в `data/mentors.json` или `data/admins.json`
- Убедитесь, что поле `telegram_tag` заполнено правильно

### Нет данных о домашних заданиях
- Запустите скрипт `scripts/homeworks.py` для обновления данных
- Проверьте, что файл `data/homeworks.json` существует и содержит данные

### Ошибки при загрузке данных через скрипты
- Проверьте правильность `BASE_URL`, `API_EMAIL` и `API_PASSWORD`
- Убедитесь, что у вас есть доступ к API
- При ошибке 429 (Too Many Requests) скрипты автоматически ждут и повторяют запрос

## Авторы

Korabliov Kirill
